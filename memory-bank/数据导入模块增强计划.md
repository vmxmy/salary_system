# 数据导入模块增强计划

## 目标

增强现有数据导入模块，为用户提供一个分步指南，以更清晰、更可控地完成员工信息、工资详情和扣款信息的导入。引入规则引擎进行数据验证，并使用 pandas 进行数据验证与合并，确保数据质量和导入的准确性。增加数据预览步骤，允许用户在最终导入前检查数据，并提供详细的错误处理机制。

## 详细计划

### 1. 前端 (`frontend/salary-viewer/src/components/FileConverter.tsx`)

*   **用户界面修改：** 引入一个分步组件（例如 Ant Design 的 Steps），将数据导入过程分解为以下几个明确的步骤：
    *   步骤 1：员工信息导入
    *   步骤 2：工资详情导入
    *   步骤 3：扣款信息导入
    *   步骤 4：数据预览与确认
*   **员工信息导入步骤：** 在此步骤中，添加一个选项允许用户跳过此步骤，如果本次导入不涉及新员工的添加。用户可以选择上传员工信息文件或直接进入下一步。
*   **文件上传逻辑更新：** 修改现有的文件上传处理函数，使其能够根据用户当前所处的导入步骤，将文件以及相关的步骤信息发送到后端对应的接口或附带不同的参数。
*   **结果展示优化：** 根据后端返回的包含详细验证结果（包括规则引擎的验证结果）的响应，在前端清晰地展示每一步的验证状态（成功、警告、错误）、具体的错误信息和警告详情，并为用户提供如何修正数据的指导。对于错误，应明确指出错误类型（例如，文件格式错误、数据验证失败、规则不匹配等）和具体位置（例如，文件名、工作表名、行号、列名）。
*   **数据预览界面：** 在步骤 4 中，展示后端返回的经过验证和合并后的数据预览。使用表格组件清晰地呈现数据，允许用户在最终导入前进行检查。对于存在警告或错误的记录，应在预览界面中进行标记或突出显示，并提供查看详细错误信息的功能。提供确认导入和返回修改的选项。

### 2. 后端 (主要在 `webapp` 目录)

*   **分步流程处理：** 在后端实现一个逻辑层，负责接收前端发送的分步导入请求，并根据请求中的步骤信息，协调相应的数据处理流程。
*   **规则引擎管理模块：** 在 `webapp/core/` 目录下创建一个新的模块，例如 `rule_engine.py`，用于封装规则引擎的实现。该模块应提供接口，允许根据预定义的规则对数据进行验证。规则应是可配置的，并能根据导入的数据类型（工资详情、扣款信息）加载相应的规则集。**建议使用 Python 的 `Rule-Engine` 框架来实现规则引擎，因为它轻量且易于集成，适用于基于映射关系的数据验证场景。规则的存储方式初步建议使用 JSON 配置文件，方便管理和修改；未来可考虑迁移到数据库以支持更复杂的规则管理界面。**
    *   **工资详情验证规则：** 实现基于以下映射的验证规则：
        ```text
        {
          "雇佣类型": "正式员工",
          "导入表": ["公务员", "事业单位", "公用事业"]
        },
        {
          "雇佣类型": "合同员工",
          "导入表": ["专项项目", "技术员", "区县聘", "前投资服务"]
        }
        ```
    *   **扣款信息验证规则：** 实现基于以下映射的验证规则：
        ```text
        {
          "扣款类型": "政府养老金与年金",
          "导入表": [
            "政府机构基本养老金（雇主）",
            "政府机构基本养老金（员工）",
            "政府常规年金（雇主）- 非体系",
            "政府常规年金（员工）- 非体系"
          ]
        },
        {
          "扣款类型": "企业保险",
          "导入表": [
            "工伤保险（雇主）",
            "失业保险（雇主）",
            "失业保险（员工）",
            "基本养老保险（雇主）",
            "基本养老保险（员工）"
          ]
        },
        {
          "扣款类型": "医保",
          "导入表": [
            "重大疾病保险（雇主）",
            "重大疾病保险（员工）",
            "基本医疗保险（员工）"
          ]
        },
        {
          "扣款类型": "个人所得税",
          "导入表": ["个人所得税"]
        },
        {
          "扣款类型": "住房公积金",
          "导入表": ["住房公积金（雇主 + 员工）"]
        }
        ```
*   **数据验证与合并 (Pandas)：** 在后端数据处理流程中，确保在接收到工资详情和扣款信息文件后，将数据加载到 pandas DataFrames 中。利用 pandas 的强大功能进行数据清洗、验证（除了规则引擎的验证外，还可以包括数据类型检查、缺失值处理等）和合并操作。
*   **数据预览准备：** 在 pandas 验证和合并完成后，将处理好的数据（或其摘要/样本，取决于数据量）以及详细的验证结果（包括哪些记录有错误、错误类型和详情）返回给前端，用于数据预览步骤。
*   **最终导入处理：** 添加一个新的后端接口，用于接收用户在数据预览步骤中确认导入的请求。接收到确认后，触发将最终数据插入到后端数据库暂存表的逻辑。
*   **原子函数：** 设计和实现一系列原子函数，负责在源数据格式（Excel 工作表中的列）和目标数据格式（数据库暂存表的列）之间进行精确的数据转换和映射。这些函数应是独立的、可测试的，并能在不同的导入步骤中重用。
*   **API 接口调整：** 更新现有的 `/api/convert/excel-to-csv` 接口或创建新的接口（例如 `/api/import/step1_employees`, `/api/import/step2_salary`, `/api/import/step3_deductions`, `/api/import/preview`, `/api/import/confirm`），以支持分步导入流程和数据预览。后端接口应返回详细的处理结果，包括每一步的验证状态、具体问题以及用于预览的数据。
*   **错误处理机制：**
    *   **文件上传/格式错误：** 在接收文件时进行初步检查，如文件类型、大小等。文件格式错误（如非法的 Excel 文件）应立即中断处理，并向前端返回明确的错误信息。
    *   **数据解析错误：** 在将 Excel 数据加载到 pandas DataFrame 时，处理可能的解析错误（如编码问题、单元格格式错误）。对于无法解析的行或单元格，可以记录错误并跳过，或根据配置决定是否中断整个导入过程。
    *   **规则引擎验证错误：** 规则引擎验证失败时，应记录所有不符合规则的数据记录及其具体的错误原因（例如，雇佣类型与导入表不匹配）。这些错误信息将返回给前端，用于在预览阶段展示。可以选择跳过包含规则错误的记录，或要求用户修正后重新上传。
    *   **Pandas 验证/合并错误：** 在 pandas 中进行数据类型转换、缺失值处理、数据合并等操作时，捕获并记录发生的错误（例如，数据类型转换失败、合并键不存在）。将这些错误信息与数据一起返回前端。
    *   **数据库插入错误：** 在将数据插入数据库时，处理可能的数据库错误（例如，主键冲突、外键约束、数据类型不匹配）。对于插入失败的记录，应记录错误并通知用户。可以考虑批量插入以提高效率并优化错误报告。
    *   **错误报告：** 后端应生成详细的错误报告，包含错误类型、发生位置（文件、工作表、行、列）、错误原因和受影响的数据。这些报告应易于前端解析和展示，帮助用户快速定位和解决问题。
    *   **处理策略：** 对于不同类型的错误，可以配置不同的处理策略，例如：
        *   致命错误（如文件无法打开）：中断整个导入流程。
        *   数据验证错误（如规则不匹配）：记录错误，跳过问题记录，允许继续处理其他记录，并在预览中突出显示。
        *   警告（如非预期列）：记录警告，但不中断流程。

### 3. 数据库

*   **暂存表结构：** 检查和确认现有的数据库暂存表结构（参考 `sql/create_staging_tables.sql` 和 alembic 版本迁移脚本），确保它们能够存储分步导入过程中产生的中间数据以及最终合并后的数据结构。如果需要，进行相应的数据库迁移。

## 流程图

```mermaid
graph TD
    A[用户] --> B{选择导入类型};
    B --> C{员工信息导入};
    C -- 跳过 --> D{工资详情导入};
    C -- 导入 --> E[上传员工文件] --> F{后端处理员工数据};
    F --> D;
    D --> G[上传工资文件] --> H{后端处理工资数据};
    H -- 使用规则引擎验证 --> I{验证结果};
    I -- 错误 --> D;
    I -- 成功 --> J{扣款信息导入};
    J --> K[上传扣款文件] --> L{后端处理扣款数据};
    L -- 使用规则引擎验证 --> M{验证结果};
    M -- 错误 --> J;
    M -- 成功 --> N{后端数据验证与合并};
    N -- 使用Pandas --> O[数据加载到Pandas];
    O -- 验证与合并 --> P[准备最终数据];
    P --> PV{数据预览};
    PV -- 确认 --> Q{插入数据库};
    PV -- 返回修改 --> B; %% 或者返回到需要修改的步骤，这里简化为返回开始
    Q -- 成功 --> R[导入完成];
    Q -- 失败 --> N; %% 插入失败可能需要重新验证或合并

    subgraph Frontend
        B
        C
        E
        G
        J
        K
        PV
        R
    end

    subgraph Backend
        F
        H
        I
        L
        M
        N
        O
        P
        Q
    end

    subgraph Rule Engine Module
        RE[规则引擎]
    end

    subgraph Database
        DB[(数据库)]
    end

    H -- 调用 --> RE;
    L -- 调用 --> RE;
    P --> Backend; %% 数据返回给后端，再由后端发送给前端预览
    Q --> DB;