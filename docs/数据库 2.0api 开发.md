# HR and Payroll System API Design Principles (v2)

本文档详细描述了构建人事和工资管理系统 API 的设计标准和原则，以及如何将其应用于前面设计的数据库结构。所有 API 接口均使用 `/v2/` 版本标识。

## 1. HTTP 方法使用

本 API 严格遵循标准的 HTTP 方法，每个方法对应资源的不同操作：

* **GET:** 用于检索资源（单个资源或资源集合）。安全且幂等。
    * 示例: `GET /v2/employees`, `GET /v2/employees/123`
* **POST:** 用于在一个资源集合下创建新的资源。非幂等。
    * 示例: `POST /v2/employees` (请求体包含新员工数据)
* **PUT:** 用于完整更新一个已存在的资源。如果资源不存在，通常会创建一个新资源（取决于具体实现）。幂等。
    * 示例: `PUT /v2/employees/123` (请求体包含 ID 为 123 的员工的完整最新数据)
* **PATCH:** 用于对已存在的资源进行部分更新。请求体只包含需要修改的字段。非幂等。
    * 示例: `PATCH /v2/employees/123` (请求体包含需要修改的员工部分字段)
* **DELETE:** 用于删除指定的资源。幂等。
    * 示例: `DELETE /v2/employees/123`

## 2. RESTful 设计原则

本 API 遵循以下 RESTful 核心原则：

* **资源导向:** 系统中的每一个关键概念（如员工、部门、工资单）都被视为资源，并拥有唯一的 URI (Uniform Resource Identifier)。URI 用于标识资源。
    * 示例: `/v2/employees`, `/v2/payroll-entries/456`
* **无状态性:** 每个来自客户端的请求必须包含服务器完成该请求所需的所有信息。服务器不会在请求之间保留客户端的上下文信息。这提高了 API 的可伸缩性和可靠性。
* **一致性:** 使用一致的命名约定、URI 结构和接口行为。例如，资源集合使用复数名词，URI 层级反映资源之间的关系或包含版本信息。
    * 示例: `/v2/departments`, `/v2/job-titles`, `/v2/payroll-periods`
* **（可选）统一接口:** 在可能的范围内，使用标准的 HTTP 方法、状态码、媒体类型（如 JSON）等，简化客户端与 API 的交互。

## 3. 资源识别与 URI 设计

将数据库中的关键表和信息映射为 API 资源，并设计其 URI。URI 结构通常包含版本号和资源集合名。

* **员工:** `/v2/employees`, `/v2/employees/{employeeId}`
* **部门:** `/v2/departments`, `/v2/departments/{departmentId}`
* **职位:** `/v2/job-titles`, `/v2/job-titles/{jobTitleId}`
* **员工历史记录类 (Job History, Contracts, Compensation, Payroll Components, Leave Balances, Leave Requests):** 这些可以设计为独立的集合资源，并通过查询参数关联员工 ID。
    * `/v2/employee-job-history`, `/v2/employee-job-history/{historyId}`
    * `/v2/employee-contracts`, `/v2/employee-contracts/{contractId}`
    * `/v2/employee-compensation-history`, `/v2/employee-compensation-history/{compensationId}`
    * `/v2/employee-payroll-components`, `/v2/employee-payroll-components/{componentConfigId}`
    * `/v2/employee-leave-balances`, `/v2/employee-leave-balances/{balanceId}`
    * `/v2/employee-leave-requests`, `/v2/employee-leave-requests/{requestId}`
* **假期类型:** `/v2/leave-types`, `/v2/leave-types/{leaveTypeId}`
* **工资周期:** `/v2/payroll-periods`, `/v2/payroll-periods/{periodId}`
* **工资运行批次:** `/v2/payroll-runs`, `/v2/payroll-runs/{runId}`
* **工资明细/工资单:** `/v2/payroll-entries`, `/v2/payroll-entries/{entryId}` (支持按员工、周期或批次过滤)
    * *用户友好别名*: 可以考虑提供一个更友好的别名，例如 `/v2/employees/{employeeId}/payslips`，但在内部映射到 `/v2/payroll-entries?employeeId={employeeId}`。
* **配置数据 (Lookup types/values, Parameters, Component Definitions, Tax/SS Rates):**
    * `/v2/config/lookup-types`, `/v2/config/lookup-types/{typeId}`
    * `/v2/config/lookup-values`, `/v2/config/lookup-values/{valueId}`
    * `/v2/config/parameters`, `/v2/config/parameters/{key}`
    * `/v2/config/payroll-components`, `/v2/config/payroll-components/{componentId}`
    * `/v2/config/tax-brackets`, `/v2/config/tax-brackets/{bracketId}`
    * `/v2/config/social-security-rates`, `/v2/config/social-security-rates/{rateId}`
* **安全资源 (Users, Roles, Permissions):**
    * `/v2/users`, `/v2/users/{userId}`
    * `/v2/roles`, `/v2/roles/{roleId}`
    * `/v2/permissions`, `/v2/permissions/{permissionId}`
    * 用户角色关联等可以通过用户或角色资源进行管理，或单独提供接口。

## 4. 响应格式

API 响应通常使用 JSON 格式。

* **统一的成功响应结构:**
    * 获取单个资源: `{ "data": { ...资源对象... } }`
    * 获取资源集合: `{ "data": [ { ...资源对象... }, ... ], "meta": { ...分页、总数等元信息... } }`
* **JSONB 字段处理:** 数据库中的 JSONB 字段 (`earnings_details`, `deductions_details` 等) 在 API 响应中将被表示为嵌套的 JSON 对象。例如，工资明细资源中会包含 `earningsDetails` 和 `deductionsDetails` 两个 JSON 对象。
* **Meta 信息:** 对于返回资源集合的 GET 请求，在 `meta` 字段中包含分页信息 (`page`, `size`, `totalPages`) 和总数 (`total`) 是标准做法。

## 5. 错误处理

使用标准的 HTTP 状态码和一致的 JSON 错误响应格式：

* **标准 HTTP 状态码:**
    * `200 OK`: 请求成功 (GET, PUT, PATCH, DELETE)
    * `201 Created`: 成功创建资源 (POST)
    * `204 No Content`: 成功执行删除操作且无内容返回 (DELETE)
    * `400 Bad Request`: 请求参数或格式错误
    * `401 Unauthorized`: 需要身份验证
    * `403 Forbidden`: 已认证但无权限访问
    * `404 Not Found`: 资源不存在
    * `405 Method Not Allowed`: HTTP 方法不支持
    * `409 Conflict`: 请求与当前资源状态冲突（如试图创建已存在的唯一资源）
    * `422 Unprocessable Entity`: 请求格式正确，但由于语义错误无法处理（如数据校验失败）
    * `429 Too Many Requests`: 请求频率过高，触发限流
    * `500 Internal Server Error`: 服务器内部错误
* **错误响应格式:** 返回一个包含错误详情的 JSON 对象。
    ```json
    {
      "error": {
        "code": 400, // HTTP 状态码
        "message": "Bad Request", // 简要错误信息
        "details": "Detailed error message or explanation.", // 详细说明
        "errors": [ // 可选：字段级别的错误列表
          { "field": "fieldName", "message": "Specific error for this field" }
        ]
      }
    }
    ```
    或使用 `errors` 数组表示多个错误：
    ```json
    {
      "errors": [
        {
           "code": "VALIDATION_ERROR",
           "message": "Invalid field value",
           "field": "employeeCode",
           "details": "Employee code must be unique."
        },
        {
           "code": "BUSINESS_RULE_VIOLATION",
           "message": "Cannot terminate employee with outstanding leave requests.",
           "details": "Employee E001 has 3 pending leave requests."
        }
      ]
    }
    ```

## 6. 版本控制

通过在 URI 中包含版本号来实现 API 版本控制。当前版本标识为 `/v2/`。

* 示例: `/v2/employees`, `/v2/payroll-entries`
* 当 API 发生不兼容的变更时，可以发布新版本 (如 `/v3/`)，同时维护旧版本一段时间以兼容现有客户端。

## 7. 安全性

* **HTTPS:** 所有 API 通信必须使用 HTTPS 进行加密，保护数据传输的安全性。
* **身份验证 (Authentication):** 验证客户端的身份。推荐使用 JWT (JSON Web Token) 或 OAuth2 等无状态且安全的机制。通过 `Authorization` 头部传递凭证。
* **授权 (Authorization):** 验证已认证用户是否有权执行请求的操作。基于 `security` Schema 中定义的用户、角色和权限进行细粒度访问控制。

## 8. 文档

提供详细、最新的 API 文档，便于客户端开发人员使用。

* 推荐使用 **OpenAPI (Swagger) 规范**来定义和描述 API 接口。
* 使用 Swagger UI 或其他工具自动生成交互式 API 文档门户。
* 文档应涵盖每个接口的 URI、HTTP 方法、参数、请求/响应体示例、状态码及错误响应说明、认证方式等。

<h2>9. 限流</h2>

为保护 API 资源，防止拒绝服务攻击或滥用，应实现请求限流。

* 可以根据 IP 地址、认证用户或 API Key 设置请求速率限制。
* 超出限制时返回 `429 Too Many Requests` 状态码。

## 10. 去耦性

API 设计作为前端和后端数据存储及业务逻辑之间的中间层，天然地促进了去耦性。

* 前端仅依赖于 API 契约，与后端实现细节解耦。
* 后端可以独立于前端进行技术选型、架构调整或数据库结构的演进（只要保持 API 契约不变）。
* 复杂的业务逻辑可以封装在 API 后端，甚至拆分为独立的微服务，通过 API 协调调用。

## 11. 特殊业务流程接口

除了标准的 CRUD 操作外，人事和工资管理系统还有一些流程性的操作，这些可以建模为特定的资源或动作：

* **发起工资计算:**
    * `POST /v2/payroll-runs` (请求体可能包含周期 ID 和要包含的员工范围)
    * 响应通常返回新创建的 `payroll-run` 资源的 ID 和状态 (如 'Processing')。
* **获取工资计算状态:**
    * `GET /v2/payroll-runs/{runId}`
* **批准假期申请:**
    * `POST /v2/leave-requests/{requestId}/approve` (通常由经理或 HR 调用)
* **拒绝假期申请:**
    * `POST /v2/leave-requests/{requestId}/reject` (请求体可能包含拒绝原因)
* **归档工资运行批次:**
    * `POST /v2/payroll-runs/{runId}/archive`

这些流程性接口通常使用 POST 方法，因为它们会改变资源的状态或触发一个动作。

---

通过遵循上述设计原则和实践，您可以构建一套健壮、灵活、易于维护和扩展的 HR 和工资管理系统 API 接口。此设计涵盖了所有数据表的标准管理（增、删、改、查）需求。

---

## 12. 开发进度

截至目前，v2 API接口的开发进度如下：

### 已完成

1. ✅ 创建基础目录结构
2. ✅ 创建数据库连接模块
3. ✅ 创建ORM模型
   - 配置相关模型 (LookupType, LookupValue, SystemParameter, PayrollComponentDefinition, TaxBracket, SocialSecurityRate)
   - 人事相关模型 (Employee, Department, JobTitle, EmployeeJobHistory, EmployeeContract, EmployeeCompensationHistory, EmployeePayrollComponent, LeaveType, EmployeeLeaveBalance, EmployeeLeaveRequest)
   - 工资相关模型 (PayrollPeriod, PayrollRun, PayrollEntry)
   - 安全相关模型 (User, Role, Permission, user_roles, role_permissions)
4. ✅ 创建Pydantic模型
   - 配置相关Pydantic模型
   - 人事相关Pydantic模型
   - 工资相关Pydantic模型
   - 安全相关Pydantic模型
5. ✅ 创建CRUD操作
   - 配置相关CRUD操作
   - 人事相关CRUD操作
   - 工资相关CRUD操作
   - 安全相关CRUD操作
6. ✅ 创建核心API路由
   - 员工相关API路由 (`/v2/employees`)
   - 部门相关API路由 (`/v2/departments`)
   - 职位相关API路由 (`/v2/job-titles`)
   - 查找值相关API路由 (`/v2/lookup/types`, `/v2/lookup/values`)
7. ✅ 集成到主应用

### 已完成但需要修复的API

1. ✅ 创建配置相关API路由
   - ✅ 系统参数API路由 (`/v2/config/parameters`) - 已实现但测试失败，需要修复
   - ✅ 工资组件定义API路由 (`/v2/config/payroll-components`) - 已实现但测试失败，需要修复
   - ✅ 税率档位API路由 (`/v2/config/tax-brackets`) - 已实现但测试失败，需要修复
   - ✅ 社保费率API路由 (`/v2/config/social-security-rates`) - 已实现但测试失败，需要修复
2. ✅ 创建工资相关API路由
   - ✅ 工资周期API路由 (`/v2/payroll-periods`) - 已实现，GET请求正常，POST请求失败
   - ✅ 工资运行批次API路由 (`/v2/payroll-runs`) - 已实现，GET请求正常，其他请求失败
   - ✅ 工资明细API路由 (`/v2/payroll-entries`) - 已实现但测试失败，需要修复
3. ✅ 创建安全相关API路由
   - ✅ 用户API路由 (`/v2/users`) - 已实现且测试通过
   - ✅ 角色API路由 (`/v2/roles`) - 已实现且测试通过
   - ✅ 权限API路由 (`/v2/permissions`) - 已实现但测试失败，需要修复

### 测试结果

最新API测试结果如下：

* 总测试数: 37
* 通过测试: 14
* 失败测试: 23
* 通过率: 37.84%

已通过测试的API端点：
1. 认证 (`/v2/token`)
2. 员工列表 (`GET /v2/employees`)
3. 部门列表 (`GET /v2/departments`)
4. 职位列表 (`GET /v2/job-titles`) - 新增通过
5. 创建职位 (`POST /v2/job-titles`) - 新增通过
6. 更新职位 (`PUT /v2/job-titles/{id}`) - 新增通过
7. 删除职位 (`DELETE /v2/job-titles/{id}`) - 新增通过
8. 查找类型列表 (`GET /v2/lookup/types`)
9. 获取单个查找类型 (`GET /v2/lookup/types/{id}`) - 新增通过
10. 查找值列表 (`GET /v2/lookup/values`)
11. 工资周期列表 (`GET /v2/payroll-periods`)
12. 工资运行批次列表 (`GET /v2/payroll-runs`)
13. 用户列表 (`GET /v2/users`)
14. 获取单个用户 (`GET /v2/users/{id}`)
15. 角色列表 (`GET /v2/roles`)

### 待完成

1. ✅ 修复职位相关API路由 (`/v2/job-titles`) - 已修复并通过测试
2. ✅ 修复配置相关API路由 - 已修复代码，但仍需测试
3. ❌ 修复工资相关API路由
4. ❌ 修复权限API路由
5. ❌ 编写API文档
6. ❌ 部署到生产环境

### 下一步工作

1. ✅ 修复职位相关API路由 - 已添加缺失的CRUD函数并通过测试
2. ✅ 修复配置相关API路由 - 已添加缺失的CRUD函数，但仍需测试
3. ❌ 修复工资相关API路由
4. ❌ 修复权限API路由
5. ❌ 编写API文档
6. ❌ 部署到生产环境

### 详细测试结果

以下是最新的API测试结果详情：

```bash
✓ 登录成功，获取到JWT令牌

测试分类: employees

测试: GET /v2/employees
描述: 获取员工列表
状态码: 200
响应时间: 0.0866秒
响应内容:
{
  "data": [],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 0,
    "totalPages": 1
  }
}
⚠ 无法获取有效的ID，跳过测试: GET /v2/employees/{id}

测试: POST /v2/employees
描述: 创建员工
请求失败，无响应
⚠ 无法获取有效的ID，跳过测试: PUT /v2/employees/{id}
⚠ 无法获取有效的ID，跳过测试: DELETE /v2/employees/{id}

测试分类: departments

测试: GET /v2/departments
描述: 获取部门列表
状态码: 200
响应时间: 0.0072秒
响应内容:
{
  "data": [],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 0,
    "totalPages": 1
  }
}
⚠ 无法获取有效的ID，跳过测试: GET /v2/departments/{id}

测试: POST /v2/departments
描述: 创建部门
请求失败，无响应
⚠ 无法获取有效的ID，跳过测试: PUT /v2/departments/{id}
⚠ 无法获取有效的ID，跳过测试: DELETE /v2/departments/{id}

测试分类: job_titles

测试: GET /v2/job-titles
描述: 获取职位列表
状态码: 200
响应时间: 0.0078秒
响应内容:
{
  "data": [],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 0,
    "totalPages": 1
  }
}
⚠ 无法获取有效的ID，跳过测试: GET /v2/job-titles/{id}

测试: POST /v2/job-titles
描述: 创建职位
状态码: 201
响应时间: 0.0101秒
响应内容:
{
  "data": {
    "code": "JT001",
    "name": "软件工程师",
    "description": null,
    "effective_date": "2023-01-01",
    "end_date": null,
    "is_active": true,
    "id": 1
  }
}

测试: PUT /v2/job-titles/{id}
描述: 更新职位
状态码: 200
响应时间: 0.0068秒
响应内容:
{
  "data": {
    "code": "JT001",
    "name": "高级软件工程师",
    "description": null,
    "effective_date": "2023-01-01",
    "end_date": null,
    "is_active": true,
    "id": 1
  }
}

测试: DELETE /v2/job-titles/{id}
描述: 删除职位
状态码: 204
响应时间: 0.0078秒
响应内容:
响应内容:

测试分类: lookup

测试: GET /v2/lookup/types
描述: 获取查找类型列表
状态码: 200
响应时间: 0.0054秒
响应内容:
{
  "data": [
    {
      "code": "GENDER",
      "name": "性别",
      "description": null,
      "id": 1
    }
  ],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 1,
    "totalPages": 1
  }
}

测试: GET /v2/lookup/types/{id}
描述: 获取单个查找类型
状态码: 200
响应时间: 0.0032秒
响应内容:
{
  "data": {
    "code": "GENDER",
    "name": "性别",
    "description": null,
    "id": 1
  }
}

测试: POST /v2/lookup/types
描述: 创建查找类型
请求失败，无响应

测试: GET /v2/lookup/values
描述: 获取查找值列表
状态码: 200
响应时间: 0.0061秒
响应内容:
{
  "data": [],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 0,
    "totalPages": 1
  }
}
⚠ 无法获取有效的ID，跳过测试: GET /v2/lookup/values/{id}

测试: POST /v2/lookup/values
描述: 创建查找值
请求失败，无响应

测试分类: config

测试: GET /v2/config/parameters
描述: 获取系统参数列表
请求失败，无响应

测试: GET /v2/config/parameters/{id}
描述: 获取单个系统参数
请求失败，无响应

测试: POST /v2/config/parameters
描述: 创建系统参数
请求失败，无响应

测试: GET /v2/config/payroll-components
描述: 获取工资组件列表
请求失败，无响应

测试: GET /v2/config/tax-brackets
描述: 获取税率档位列表
请求失败，无响应

测试: GET /v2/config/social-security-rates
描述: 获取社保费率列表
请求失败，无响应

测试分类: payroll

测试: GET /v2/payroll-periods
描述: 获取工资周期列表
状态码: 200
响应时间: 0.0049秒
响应内容:
{
  "data": [],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 0,
    "totalPages": 1
  }
}
⚠ 无法获取有效的ID，跳过测试: GET /v2/payroll-periods/{id}

测试: POST /v2/payroll-periods
描述: 创建工资周期
请求失败，无响应

测试: GET /v2/payroll-runs
描述: 获取工资运行批次列表
状态码: 200
响应时间: 0.0052秒
响应内容:
{
  "data": [],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 0,
    "totalPages": 1
  }
}

测试: GET /v2/payroll-entries
描述: 获取工资明细列表
请求失败，无响应

测试分类: security

测试: GET /v2/users
描述: 获取用户列表
状态码: 200
响应时间: 0.0062秒
响应内容:
{
  "data": [
    {
      "username": "admin",
      "employee_id": null,
      "is_active": true,
      "id": 1,
      "created_at": "2025-05-14T03:47:10.400669Z"
    },
    {
      "username": "testuser",
      "employee_id": null,
      "is_active": true,
      "id": 2,
      "created_at": "2025-05-14T04:26:21.867179Z"
    }
  ],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 2,
    "totalPages": 1
  }
}

测试: GET /v2/users/{id}
描述: 获取单个用户
状态码: 200
响应时间: 0.0035秒
响应内容:
{
  "data": {
    "username": "admin",
    "employee_id": null,
    "is_active": true,
    "id": 1,
    "created_at": "2025-05-14T03:47:10.400669Z"
  }
}

测试: POST /v2/users
描述: 创建用户
请求失败，无响应

测试: GET /v2/roles
描述: 获取角色列表
状态码: 200
响应时间: 0.0052秒
响应内容:
{
  "data": [
    {
      "code": "SUPER_ADMIN",
      "name": "Super Admin",
      "id": 1
    }
  ],
  "meta": {
    "page": 1,
    "size": 10,
    "total": 1,
    "totalPages": 1
  }
}

测试: GET /v2/permissions
描述: 获取权限列表
请求失败，无响应

测试摘要:
总测试数: 37
通过测试: 14
失败测试: 23
通过率: 37.84%
```

### API测试工具

我们创建了一个灵活的API测试脚本，可以通过命令行参数指定要测试的API接口，支持所有v2版本的接口测试。

测试脚本位于 `webapp/v2/scripts/api_tester.py`，使用方法详见 `webapp/v2/scripts/README.md`。

#### 运行测试

可以使用以下命令运行测试：

```bash
# 进入脚本目录
cd webapp/v2/scripts

# 列出所有可用的API端点
python api_tester.py --list-endpoints

# 测试所有API端点
python api_tester.py --test-all

# 测试特定分类的API端点
python api_tester.py --test-all --categories employees,departments

# 测试单个API端点
python api_tester.py --endpoint /v2/employees --method GET
```

也可以使用提供的Shell脚本运行测试并生成报告：

```bash
cd webapp/v2/scripts
./run_api_tests.sh
```

---