# 1.2 API Design and Endpoints (Backend v2)

This document details the design principles, conventions, and specific endpoint structures for the v2 backend API of the Salary Information Management System. It is largely based on the comprehensive design outlined in `docs/v2/API 架构2.0md`.

## 1. Core API Design Principles

*Refer to `docs/v2/API 架构2.0md` Sections 1 (HTTP Methods), 2 (RESTful Design), 6 (Versioning), 7 (Security), 9 (Rate Limiting), and 10 (Decoupling) for detailed explanations of these principles.*

*   **HTTP Methods:** Strict adherence to GET, POST, PUT, PATCH, DELETE semantics.
*   **RESTful Design:** Resource-oriented, stateless, consistent URI structure.
*   **Versioning:** API versioned via URI path (e.g., `/v2/...`).
*   **Security:** HTTPS, JWT-based authentication, role-based authorization.
*   **Rate Limiting:** Implemented to prevent abuse.
*   **JSON:** Primary format for request and response bodies.

## 2. URI Structure and Naming Conventions

*Refer to `docs/v2/API 架构2.0md` Section 3 (Resource Identification & URI Design).*

*   **Base Path:** All v2 API endpoints are prefixed with `/v2/`.
*   **Resource Naming:** Use plural nouns for resource collections (e.g., `/v2/employees`, `/v2/departments`).
*   **Path Parameters:** Use path parameters to identify specific resources (e.g., `/v2/employees/{employeeId}`).

## 3. Request and Response Formats

*Refer to `docs/v2/API 架构2.0md` Section 4 (Response Format) and Section 5 (Error Handling).*

### 3.1. Successful Responses

*   **Single Resource:** `{ "data": { ...resource object... } }`
*   **Resource Collection:** `{ "data": [ { ...resource object... }, ... ], "meta": { "page": 1, "size": 10, "totalPages": 5, "total": 50 } }`
*   **Bank Export:** `text/csv` stream for `GET /v2/payroll-runs/{runId}/bank-export`.

### 3.2. Error Responses

*   Uses standard HTTP status codes (4xx for client errors, 5xx for server errors).
*   JSON error response body:
    ```json
    {
      "error": {
        "code": 400, // HTTP status code
        "message": "Bad Request", // Brief error message
        "details": "Detailed error message or explanation.", // Detailed explanation
        "errors": [ // Optional: field-level errors
          { "field": "fieldName", "message": "Specific error for this field" }
        ]
      }
    }
    ```
    Or an array of errors:
    ```json
    {
      "errors": [
        {
           "code": "VALIDATION_ERROR",
           "message": "Invalid field value",
           "field": "employeeCode",
           "details": "Employee code must be unique."
        }
      ]
    }
    ```

## 4. Key Resource Endpoints (Illustrative List)

*A comprehensive list of endpoints and their detailed Pydantic models for request/response can be found by examining the FastAPI router definitions in `webapp/v2/routers/` and the Pydantic models in `webapp/v2/pydantic_models/`. The document `docs/v2/API 架构2.0md` (Section 3 and 11) also provides an extensive list of planned resources and special business process endpoints.*

### 4.1. Employees
*   `GET /v2/employees`
*   `POST /v2/employees`
*   `GET /v2/employees/{employee_id}`
*   `PUT /v2/employees/{employee_id}`
*   `PATCH /v2/employees/{employee_id}`
*   `DELETE /v2/employees/{employee_id}`

### 4.2. Departments
*   `GET /v2/departments`
*   `POST /v2/departments`
*   ...(CRUD operations)

### 4.3. Job Titles
*   `GET /v2/job-titles`
*   `POST /v2/job-titles`
*   ...(CRUD operations)

### 4.4. Payroll Runs
*   `GET /v2/payroll-runs`
*   `POST /v2/payroll-runs`
*   `GET /v2/payroll-runs/{run_id}`
*   `PATCH /v2/payroll-runs/{run_id}` (e.g., to update status, mark as paid)
*   `GET /v2/payroll-runs/{run_id}/bank-export`
*   `POST /v2/payroll-runs/{run_id}/archive`

### 4.5. Payroll Entries (Payslips)
*   `GET /v2/payroll-entries` (filterable by employee, run, period)
*   `GET /v2/payroll-entries/{entry_id}`
*   `PATCH /v2/payroll-entries/{entry_id}` (e.g., for adjustments, audit status)

### 4.6. System Configuration (Examples)
*   `GET /v2/config/lookup-types`
*   `GET /v2/config/lookup-values`
*   `GET /v2/config/payroll-components`

### 4.7. Authentication
*   `POST /v2/token` (Login - username/password, returns JWT)

## 5. API Documentation (Swagger/OpenAPI)

*   The live, interactive API documentation is generated by FastAPI and is typically available at the `/docs` endpoint of the running backend application (e.g., `http://localhost:8000/v2/docs`).
*   This documentation provides the most up-to-date details on all available endpoints, request/response schemas, and allows for direct interaction with the API.

*This document serves as a high-level guide. For exhaustive details, refer to `docs/v2/API 架构2.0md` and the auto-generated OpenAPI documentation from the running application.* 